<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h2 id="dashHeading">Admin Dashboard</h2>

    <div style="padding: 20px;">

        <!-- Admin Stats -->
        <div style="display:flex; gap:20px; margin-bottom:30px;">
            <div style="border:1px solid #ccc; padding:20px; border-radius:8px; min-width:150px; text-align:center;">
                <h3>Total Tasks</h3>
                <p id="totalTasks" style="font-size:2rem; font-weight:bold;">-</p>
            </div>
            <div style="border:1px solid #ccc; padding:20px; border-radius:8px; min-width:150px; text-align:center;">
                <h3>Completed</h3>
                <p id="completedTasks" style="font-size:2rem; font-weight:bold; color:green;">-</p>
            </div>
            <div style="border:1px solid #ccc; padding:20px; border-radius:8px; min-width:150px; text-align:center;">
                <h3>Pending</h3>
                <p id="pendingTasks" style="font-size:2rem; font-weight:bold; color:orange;">-</p>
            </div>
        </div>

        <!-- All Tasks Table -->
        <h3>All Users Tasks</h3>
        <table id="taskTable" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#f0f0f0;">
                    <th style="border:1px solid #ccc; padding:10px;">ID</th>
                    <th style="border:1px solid #ccc; padding:10px;">Title</th>
                    <th style="border:1px solid #ccc; padding:10px;">Description</th>
                    <th style="border:1px solid #ccc; padding:10px;">Created By</th>
                    <th style="border:1px solid #ccc; padding:10px;">Status</th>
                    <th style="border:1px solid #ccc; padding:10px;">Actions</th>
                </tr>
            </thead>
            <tbody id="taskTableBody">
                <tr><td colspan="6" style="text-align:center; padding:20px;">Loading...</td></tr>
            </tbody>
        </table>

        <br>
        <button onclick="window.location.href='tasks.html'"
            style="padding:10px 20px; background:#333; color:white; border:none; border-radius:6px; cursor:pointer;">
            Go to My Tasks
        </button>
        <button onclick="logout()"
            style="padding:10px 20px; background:red; color:white; border:none; border-radius:6px; cursor:pointer; margin-left:10px;">
            Logout
        </button>
    </div>

    <script src="script.js"></script>
    <script>
        // Check admin access
        const token = getToken();
        if (!token) {
            alert("Login first");
            window.location.href = "login.html";
        }

        const role = getUserRole();
        if (role !== "ROLE_ADMIN") {
            alert("Access Denied - Admins Only");
            window.location.href = "tasks.html";
        }

        // Load all tasks into dashboard
        async function loadDashboard() {
            const tasks = await getTasks();

            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const pending = total - completed;

            document.getElementById("totalTasks").innerText = total;
            document.getElementById("completedTasks").innerText = completed;
            document.getElementById("pendingTasks").innerText = pending;

            const tbody = document.getElementById("taskTableBody");
            tbody.innerHTML = "";

            if (tasks.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">No tasks found</td></tr>`;
                return;
            }

            tasks.forEach(t => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td style="border:1px solid #ccc; padding:8px; text-align:center;">${t.id}</td>
                    <td style="border:1px solid #ccc; padding:8px;">${t.title || "Untitled"}</td>
                    <td style="border:1px solid #ccc; padding:8px;">${t.description || "-"}</td>
                    <td style="border:1px solid #ccc; padding:8px;">${t.createdBy}</td>
                    <td style="border:1px solid #ccc; padding:8px; text-align:center;">
                        ${t.completed ? "✅ Completed" : "⏳ Pending"}
                    </td>
                    <td style="border:1px solid #ccc; padding:8px; text-align:center;">
                        <button onclick="toggleTask(${t.id}, ${t.completed})"
                            style="background:green; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; margin-right:5px;">
                            Toggle
                        </button>
                        <button onclick="deleteTask(${t.id})"
                            style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">
                            Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Override toggleTask & deleteTask to reload dashboard after action
        const _toggle = toggleTask;
        const _delete = deleteTask;

        async function toggleTask(id, status) {
            await _toggle(id, status);
            loadDashboard();
        }

        async function deleteTask(id) {
            await _delete(id);
            loadDashboard();
        }

        loadDashboard();
    </script>
</body>
</html>
